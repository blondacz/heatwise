# .github/workflows/docker-publish.yml
name: docker-publish

on:
  push:
    branches: ["disabled"]
    tags: [ 'v*.*.*' ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: heatwise   # change if you rename your repo image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Multi-arch builder (useful if you want arm64 for Pi + amd64 for laptops/cloud)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image coordinates and tags
        id: meta
        run: |
          OWNER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER}/${IMAGE_NAME}"

          # Default tags: short sha + latest (on main/master)
          SHA_TAG=${GITHUB_SHA::12}
          TAGS="${IMAGE}:${SHA_TAG}"

          if [[ "${GITHUB_REF}" == "refs/heads/main" || "${GITHUB_REF}" == "refs/heads/master" ]]; then
            TAGS="${TAGS},${IMAGE}:latest"
          fi

          # If pushing a tag like v0.1.0, add that tag too
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VER="${GITHUB_REF#refs/tags/}"
            TAGS="${TAGS},${IMAGE}:${VER}"
          fi

          echo "image=${IMAGE}"         >> $GITHUB_OUTPUT
          echo "tags=${TAGS}"           >> $GITHUB_OUTPUT

      - name: Build and push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/Dockerfile
          push: true
          # Build for both amd64 and arm64; drop arm64 if you don't need it
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
